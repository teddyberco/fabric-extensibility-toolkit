<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Excel Creation</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        button { padding: 10px 20px; margin: 10px; background: #0078d4; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #106ebe; }
        .log { background: #f5f5f5; padding: 10px; border-radius: 4px; white-space: pre-wrap; font-family: monospace; margin-top: 10px; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Excel Creation Test</h1>
        
        <div class="test-section">
            <h2>Test Real Excel Creation</h2>
            <p>This will test the delegated permissions OAuth flow for creating a real Excel file in OneDrive.</p>
            <button onclick="testRealExcel()">Create Real Excel</button>
            <button onclick="checkAuthAndRetry()">Check Auth & Retry</button>
            <div id="realExcelLog" class="log"></div>
        </div>

        <div class="test-section">
            <h2>Test Mock Excel Creation</h2>
            <p>This will test the mock Excel creation that doesn't require authentication.</p>
            <button onclick="testMockExcel()">Create Mock Excel</button>
            <div id="mockExcelLog" class="log"></div>
        </div>

        <div class="test-section">
            <h2>Check Authentication Status</h2>
            <p>Check if user is already authenticated with delegated permissions.</p>
            <button onclick="checkAuthStatus()">Check Auth Status</button>
            <div id="authStatusLog" class="log"></div>
        </div>
    </div>

    <script>
        function log(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const className = isError ? 'error' : 'success';
            element.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            element.scrollTop = element.scrollHeight;
        }

        function clearLog(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }

        async function testRealExcel() {
            clearLog('realExcelLog');
            log('realExcelLog', 'Starting real Excel creation test...');
            
            const testData = {
                tableName: "TestData",
                tableData: [
                    ["Name", "Age", "City"],
                    ["John Doe", "30", "New York"],
                    ["Jane Smith", "25", "Los Angeles"],
                    ["Bob Johnson", "35", "Chicago"]
                ],
                schema: [
                    { name: "Name", type: "string" },
                    { name: "Age", type: "number" },
                    { name: "City", type: "string" }
                ]
            };

            try {
                log('realExcelLog', 'Sending request to /api/excel/create-real...');
                
                const response = await fetch('/api/excel/create-real', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testData)
                });

                const result = await response.text();
                log('realExcelLog', `Response status: ${response.status}`);
                
                if (response.ok) {
                    const jsonResult = JSON.parse(result);
                    if (jsonResult.success && jsonResult.embedUrl) {
                        log('realExcelLog', `‚úÖ Excel created successfully! Embed URL: ${jsonResult.embedUrl}`);
                        if (jsonResult.webUrl) {
                            log('realExcelLog', `üîó Opening Excel file: ${jsonResult.webUrl}`);
                            window.open(jsonResult.webUrl, '_blank');
                        }
                    } else if (jsonResult.requiresAuth) {
                        log('realExcelLog', `üîê Authentication required: ${jsonResult.message}`);
                        log('realExcelLog', `üìã Instructions: ${jsonResult.instructions}`);
                        log('realExcelLog', `üåê Opening consent page...`);
                        
                        // Open consent page in new window
                        const authWindow = window.open(jsonResult.authUrl, 'auth', 'width=600,height=700,scrollbars=yes,resizable=yes');
                        
                        // Monitor for auth completion
                        const checkAuthComplete = setInterval(() => {
                            try {
                                if (authWindow.closed) {
                                    clearInterval(checkAuthComplete);
                                    log('realExcelLog', `üîÑ Auth window closed. You can now try creating Excel again.`);
                                }
                            } catch (e) {
                                // Cross-origin error when auth redirects - this is expected
                            }
                        }, 1000);
                        
                        log('realExcelLog', `‚è≥ Waiting for authentication to complete...`);
                    } else {
                        log('realExcelLog', `‚ö†Ô∏è Response received but unexpected format: ${result}`);
                    }
                } else {
                    const errorResult = JSON.parse(result);
                    log('realExcelLog', `‚ùå Request failed: ${errorResult.error || result}`, true);
                }
            } catch (error) {
                log('realExcelLog', `‚ùå Error: ${error.message}`, true);
            }
        }

        async function checkAuthAndRetry() {
            log('realExcelLog', 'üîç Checking authentication status and retrying Excel creation...');
            await testRealExcel();
        }

        async function testMockExcel() {
            clearLog('mockExcelLog');
            log('mockExcelLog', 'Starting mock Excel creation test...');
            
            const testData = {
                tableName: "MockTestData",
                data: [
                    ["Product", "Price", "Category"],
                    ["Laptop", "999", "Electronics"],
                    ["Book", "19.99", "Education"],
                    ["Chair", "89.99", "Furniture"]
                ],
                metadata: {
                    lakehouseId: "test-lakehouse-123"
                }
            };

            try {
                log('mockExcelLog', 'Sending request to /wopi/createFromLakehouse...');
                
                const response = await fetch('/wopi/createFromLakehouse', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testData)
                });

                const result = await response.text();
                log('mockExcelLog', `Response status: ${response.status}`);
                log('mockExcelLog', `Response: ${result}`);

                if (response.ok) {
                    const jsonResult = JSON.parse(result);
                    if (jsonResult.excelOnlineUrl) {
                        log('mockExcelLog', `‚úÖ Mock Excel created! URL: ${jsonResult.excelOnlineUrl}`);
                        window.open(jsonResult.excelOnlineUrl, '_blank');
                    }
                } else {
                    log('mockExcelLog', `‚ùå Request failed: ${result}`, true);
                }
            } catch (error) {
                log('mockExcelLog', `‚ùå Error: ${error.message}`, true);
            }
        }

        async function checkAuthStatus() {
            clearLog('authStatusLog');
            log('authStatusLog', 'Checking authentication status...');
            
            try {
                const response = await fetch('/api/excel/list', {
                    method: 'GET'
                });

                const result = await response.text();
                log('authStatusLog', `Response status: ${response.status}`);
                log('authStatusLog', `Response: ${result}`);
                
            } catch (error) {
                log('authStatusLog', `‚ùå Error: ${error.message}`, true);
            }
        }
    </script>
</body>
</html>